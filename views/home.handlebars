<!-- link to chart.js-->
<script src=https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js></script>
<!-- whatever goes here will render in the 'body' in main.handlebars-->
<div class="matchup-container">
  <h1 class="fight-title">Who would win in a fight?</h1>
  <div class="animal-container">
    <div class="button-wrapper">
      <button
        data-vote="1"
        data-matchup_id="{{matchup_id}}"
        data-user_id="{{session.user_id}}"
        class="animal_1-button">
        {{animal_1}}
      </button>
    </div>
    <div class="or">OR</div>
    <div class="button-wrapper">
      <button
        data-vote="2"
        data-matchup_id="{{matchup_id}}"
        data-user_id="{{session.user_id}}"
        class="animal_2-button">
        {{animal_2}}
      </button>
    </div>
  </div>
</div>
{{!-- {{#if hasVoted}} --}}
    <div class="container">
        <canvas id="myChart"></canvas>
    </div>

<script>
    let myChart = document.getElementById('myChart').getContext('2d');

    let animalChart = new Chart(myChart, {
        type: 'pie',
        data:{
            labels:['Gorilla', 'Tiger'],
            datasets:[{
                label:'Votes',
                data:[
                    {{blues}},
                    {{reds}}
                ],
                backgroundColor:[
                    'red',
                    'navy'
                ]
            }]
        },
        options:{
            responsive: true
        }
    });
</script>
<div class="comments">
    <div class="comment-title">See what others said about this Matchup</div>
  {{#each comments as |comment|}}
    <article class="comment-container comment-color-{{comment.color}}">
      <img
        class="user-avi"
        height="50"
        width="50"
        src="https://avatars.dicebear.com/api/croodles/{{comment.username}}.svg"
        alt="{{comment.username}}"
      />
      <div class="comment-body">
        <div class="author">
          <h4>{{comment.username}}</h4>
        </div>
        <div class="comment">
          {{comment.comment}}
        </div>
      </div>
    </article>
  {{/each}}
  <textarea placeholder="Voice your opinion!"></textarea>
  <button class="submit-btn">Submit</button>
</div>
{{!-- {{/if}} --}}
<script>
    async function matchupFormHandler(event) {
      event.preventDefault();
      let dataset = {...event.target.dataset};
      console.log(dataset);
      const response = await fetch("/api/votes", {
          method: "POST",
          body: JSON.stringify(dataset),
          headers: {'Content-Type': 'application/json'}
      })
      if (!response.ok) return;
      else{
        let mID = dataset.matchup_id;
        let seenList = JSON.parse(localStorage.getItem("seenMatchups"));
        if (!seenList) seenList = {};
        seenList[mID] = true;
        localStorage.setItem("seenMatchups",JSON.stringify(seenList));
        let target = undefined;
        for (let i = 1; i < 13; i++){
          if (seenList[i] === undefined){
            target = i;
            break;
          }
        }
        if (target === undefined){
          target = Math.floor(Math.random() * 12) + 1;
          localStorage.setItem("seenMatchups",JSON.stringify({})); //cleared list
        }
        document.location.replace(`/api/matchups/${target}`);
      }
  }

  document
    .querySelector(".animal_1-button")
    .addEventListener("click", matchupFormHandler);
  document
    .querySelector(".animal_2-button")
    .addEventListener("click", matchupFormHandler);

  async function commentFormHandler(event) {
    event.preventDefault();

    const comment = document
      .querySelector('textarea')
      .value.trim();
    const matchup_id = window.location.toString().split("/")[
      window.location.toString().split("/").length - 1
    ];
    console.log(comment, matchup_id);
    if (comment) {
      const response = await fetch("/api/comments", {
        method: "POST",
        body: JSON.stringify({ comment, matchup_id }),
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        document.location.replace(`/api/matchups/${matchup_id}`); //reload the same matchup
      } else {
        alert(response.statusText);
      }
    }
  }

  document
    .querySelector(".submit-btn")
    .addEventListener("click", commentFormHandler);
</script>